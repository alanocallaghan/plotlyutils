---
title: d3 twitter network example
output:
  html_document:
    fig_width: 12
    fig_height: 8
    code_folding: hide
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{d3 twitter network example}
-->

# Load packages
```{r}
suppressPackageStartupMessages({
  library("rtweet")
  library("dplyr")
  library("tidytext")
  library("httr")
  library("stringr")
  library("purrr")
  library("RColorBrewer")
  library("scales")
  library("tidyr")
  library("igraph")
  library("plotlyutils")
  library("htmlwidgets")
  library("networkD3")
  library("here")  
})
```



# Hello world

`inst/htmlwidgets/hello_world.js`
```{javascript, eval=FALSE}
HTMLWidgets.widget({

  name: "hello_world",

  type: "output",

  factory: function(el, width, height) {
    return {
      renderValue: function(x) {
        el.append("Hello, world!")
      },
      resize: function(x) {
      }
    };
  }
});
```

```{r, fig.height = 1, fig.width = 1}
createWidget(
  "hello_world",
  x = list(),
  package = "plotlyutils"
)
```

# Something more familiar



```{r, fig.height = 1, fig.width = 1}
createWidget(
  "hello_edinbr",
  x = list(),
  package = "plotlyutils"
)
```

# Dependencies
We could also refactor our two widgets. We can do this by another , the YAML
configuration file.
```{yaml, eval=FALSE}
dependencies:
  - name: hello
    version: 0.0.0
    src: htmlwidgets/lib/hello/
    script: 
      - hello.js
```
Where is simply a function 
```{javascript, eval=FALSE}
function hello(el, where) {
    el.append("Hello, " + where + "!")
}
```



# Create twitter network data using twitter API via rtweet
See [Elliot Meador's talk](https://github.com/EdinbR/edinbr-talks/blob/master/2019-01-16/ElliotMeador_EdinR_stripped.html) for information on the 
specifics. 
Sincere thanks for sharing the code for this analysis.

```{r}
if (!file.exists(here("data/graph_data.rds"))) {
  create_token(
    app = 'network_tweets',
    consumer_key = Sys.getenv("consumer_key"),
    consumer_secret = Sys.getenv("consumer_secret")
    # ,
    # access_token = Sys.getenv("access_token"),
    # access_secret = Sys.getenv("access_secret")
  )
  ntweets <- 30

  alfa <- get_timeline(Sys.getenv("twitter_handle"), n = ntweets) # user handle in the quotes
  regex <- "@([A-Za-z]+[A-Za-z0-9_]+)(?![A-Za-z0-9_]*\\.)"
  replace_reg1 <- 'https://t.co/[A-Za-z\\d]+|'
  replace_reg2 <- 'http://[A-Za-z\\d]+|&amp;|&lt;|&gt|RT|https'
  replace_reg <- paste0(replace_reg1, replace_reg2)
  unnest_reg <-  "([^A-Za-z\\d#@']|'(?![A-Za-z_\\d#@]))"


  mentions <- alfa %>% 
    filter(!grepl('^RT', text)) %>%
    mutate(text = gsub(replace_reg, '', text),
      row.id = row_number()) %>%
    unnest_tokens(word,
      text,
      token = 'regex',
      pattern = unnest_reg,
      collapse = FALSE) %>%
    mutate(mentioned = ifelse(grepl('@', word), word, NA)) %>%
    distinct(mentioned) %>%
    na.omit() %>%
    pull(mentioned)

  foxtrot <- map_df(mentions, function(x) { #map_df merges the dataframes
    get_timeline(x, n = ntweets)
  })
  
  golf <- foxtrot %>%
    mutate_if(is.list, simplify_all) %>%   # take all lists and simplify
    as_tibble()  %>%
    mutate_if(is.list, as.character) %>%   # change all lists to a character
    filter(!str_detect(text  , '^RT')) %>% # this is the same as above
    mutate(text = str_replace_all(text  , replace_reg, ''),
      row.id = row_number()) %>%
    unnest_tokens(
      word,
      text,
      token = 'regex',
      pattern = unnest_reg,
      collapse = F) %>%
    mutate(mentioned = ifelse(str_detect(word, '@'), word, NA))
  golf <- filter(golf, mentioned != "@" | is.na(mentioned))
  Spectral_n <- colorRampPalette(brewer.pal(11, 'Spectral'))

  tweet_g <- golf %>% 
    transmute(screen_name = str_to_lower(str_c('@', screen_name)),
        mentioned) %>%
    na.omit() %>%
    graph_from_data_frame() %>% # from igraph
    simplify()
    
  tweet_edges <- tweet_g %>%
    as_data_frame() %>%
    as_tibble() %>%
    mutate_all(funs(str_trim(.)))
  edge_col <- tweet_edges %>%
    mutate(betweenness = edge.betweenness(tweet_g)) %>%
    arrange(betweenness) %>%
    distinct(from) %>%
    mutate(color = sample(Spectral_n(nrow(.)))) %>%
    right_join(tweet_edges) %>%
    select(name = from, to, color)

  tweet_nodes <- tweet_g %>%
    as_data_frame(., 'vertices') %>%
    as_tibble() %>%
    mutate_all(funs(str_trim(.)))

  node_col_temp <- tweet_nodes %>%
    mutate(in.degree = degree(tweet_g, mode = 'in')) %>%
    left_join(edge_col) %>%
    select(-to) %>%
    distinct() %>%
    filter(is.na(color)) %>%
    distinct() %>%
    filter(in.degree == 1) %>%
    pull(name)

  node_add <- edge_col %>%
    filter(to %in% node_col_temp) %>%
    select(name = to, color.2 = color)

  n_shared_node <- tweet_nodes %>%
    left_join(edge_col) %>%
    select(-to) %>%
    distinct() %>%
    left_join(node_add) %>%
    mutate_all(funs(ifelse(is.na(.), '', .))) %>%
    unite(color, color, color.2, sep = '') %>%
    filter(color == '') %>%
    nrow()

  node_col <- tweet_nodes %>%
    left_join(edge_col) %>%
    select(-to) %>%
    distinct() %>%
    left_join(node_add) %>%
    mutate_all(funs(ifelse(is.na(.), '', .))) %>%
    unite(color, color, color.2, sep = '') %>%
    mutate(color = ifelse(color == '', Spectral_n(n_shared_node), color))
    
  edge.cols.ad <- map2(edge_col$color,
    rescale(edge.betweenness(tweet_g), 0.5, 1),     
    function(x, y) {
     adjustcolor(x, y)
    }) %>% 
    flatten_chr()

  node.cols.ad <- map2(node_col$color, 
    rescale(degree(tweet_g), 0.5, 1), 
      function(x, y){
        adjustcolor(x, y)
      }) %>% 
    flatten_chr()
  all <- unique(c(tweet_edges$from, tweet_edges$to))
  nodes <- lapply(all, function(x) list(name = x))
  links <- tweet_edges
  links[] <- lapply(links, function(col) as.numeric(factor(col, levels = all)) - 1)
  links <- lapply(seq_len(nrow(links)), function(i) {
    list("source" = links[i, "from", drop = TRUE],
    "target" = links[i, "to", drop = TRUE])
  })

  graph_data <- list(
    nodes = nodes,
    links = links
  )
  saveRDS(graph_data, here("data/graph_data.rds"))
} else {
  graph_data <- readRDS(here("data/graph_data.rds"))
}
```

# d3Network

```{r}
colnames(tweet_edges) <- c("Source", "Target")
d <- igraph_to_networkD3(tweet_g)
d$nodes$group <- 1
forceNetwork(
  Links = d$links, 
  Nodes = d$nodes,
  NodeID = "name",
  Group = "group",
  zoom = TRUE
)
```

# The magic
```{r}
createWidget(
  "twitternetwork",
  x = graph_data,
  sizingPolicy = sizingPolicy(
  browser.fill = TRUE, 
  viewer.fill = TRUE),
  package = "plotlyutils"
)
```
